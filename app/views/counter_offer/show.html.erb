<!-- app/views/counter_offer/show.html.erb -->

<div class = "nicefont">
<h1> Trade with <%= @context.character.name %> </h1>

<h2><%= @context.character.dialogue_content %></h2>
<div>
  <p>
    <strong>Balance:</strong>
    <%= @context.character.balance %>
  </p>
  <% if not @pref.nil? %>
      <p>
          <strong>Occupation Description:</strong>
          <%= @pref.description %>
      <p>
  <% end %>
</div>

<% if @context.character %>
  <%= render partial: 'sinventory' %>

  <div class="button-group">
    <%= button_to "Barter", barter_counter_offer_path(id: @context.character.id), class: "button-b", method: :get %>
    <%= button_to "Buy", buy_counter_offer_path(id: @context.character.id), method: :get, class: "button-b" %>
    <%= button_to "Sell", sell_counter_offer_path(id: @context.character.id), method: :get, class: "button-b" %>
  </div>

  <div style="margin-top: 20px;">
  <%= form_with(url: create_counter_offer_path(id: @context.character.id), method: :post, local: true) do %>

    <div style="margin-bottom: 10px;">
    
      <% if @action == 'buy' %>

        <div style="margin-bottom: 10px;">
          <%= label_tag :item_i_want_id, 'I want' %>
          <%= select_tag :item_i_want_id, options_from_collection_for_select(Item.all, :id, :name, selected: @context.character.item_to_offer_id), include_blank: true %>
        </div>

        <div style="margin-bottom: 10px;">
          <%= label_tag :quantity_i_want, 'Quantity I want' %>
          <%= number_field_tag :quantity_i_want, @context.character.quantity_to_offer %>
        </div>

        <% item_i_want = Item.find_by(id: params[:item_i_want_id]) %>
      <% quantity_i_want = params[:quantity_i_want].to_i %>
      <% total_price = item_i_want ? item_i_want.value * quantity_i_want : 0 %>
      <strong>Total price: <%= total_price %></strong>

      <% elsif @action == 'sell' %>

        <div style="margin-bottom: 10px;">
          <%= label_tag :item_i_give_id, 'I give' %>
          <%= select_tag :item_i_give_id, options_from_collection_for_select(Item.all, :id, :name, selected: @context.character.item_to_accept_id), include_blank: true %>
        </div>

        <div style="margin-bottom: 10px;">
          <%= label_tag :quantity_i_give, 'Quantity I give' %>
          <%= number_field_tag :quantity_i_give, @context.character.quantity_to_accept %>
        </div>
        
        <div style="margin-bottom: 10px;">
          <strong>Total price: </strong>
        </div>
        <% elsif @action == 'barter' %>
        <div style="margin-bottom: 10px;">
          <%= label_tag :item_i_give_id, 'I give' %>
          <%= select_tag :item_i_give_id, options_from_collection_for_select(Item.all, :id, :name, selected: @context.character.item_to_accept_id), include_blank: true %>
        </div>

        <div style="margin-bottom: 10px;">
          <%= label_tag :quantity_i_give, 'Quantity I give' %>
          <%= number_field_tag :quantity_i_give, @context.character.quantity_to_accept %>
        </div>

        <div style="margin-bottom: 10px;">
          <%= label_tag :item_i_want_id, 'I want' %>
          <%= select_tag :item_i_want_id, options_from_collection_for_select(Item.all, :id, :name, selected: @context.character.item_to_offer_id), include_blank: true %>
        </div>

        <div style="margin-bottom: 10px;">
          <%= label_tag :quantity_i_want, 'Quantity I want' %>
          <%= number_field_tag :quantity_i_want, @context.character.quantity_to_offer %>
        </div>
      <% end %>
    </div>

    <div style="margin-bottom: 10px;">
      <%= submit_tag 'Offer' %>
    </div>
    
<% end %>
</div>

  <%# Display flash messages %>
  <% if flash[:notice] %>
    <div class="success-notice">
      <%= flash[:notice] %>
    </div>
  <% end %>

  <% if flash[:alert] %>
    <div class="error-notice">
      <%= flash[:alert] %>
    </div>
  <% end %>

<% else %>
  <p>Character not found.</p>
<% end %>

<%= button_to "Back", character_profile_path(@context.character), class: "button-b", method: :get %>

